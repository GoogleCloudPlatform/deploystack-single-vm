# I think it's a good idea to test your scripts. It's kinda awkward but you'll 
# be happy you did 


# DON'T REMOVE FROM test script.
source test-lib.sh

# END DON'T REMOVE FROM test script.


suffix=sv

# This is only needed if you tests fail alot because of overlaping runs of the
# same set of tests.
section_open "Generate random test project"
    generateProject PROJECT "$suffix"
section_close


gcloud services enable cloudresourcemanager.googleapis.com --project=$PROJECT
get_project_number PROJECT_NUMBER $PROJECT
REGION=us-central1
ZONE=us-central1-a
BASENAME=singlevm
DISKSIZE="200"
DISKTYPE="pd-standard"
DISKIMAGE="debian-cloud/debian-11-bullseye-v20220519"
MACHINETYPE="n1-standard-1"
NAME="${BASENAME}-instance"
TAGS="[\"http-server\",\"https-server\"]"
terraformDIR=terraform

gcloud config set project ${PROJECT}

terraform -chdir="$terraformDIR" init 
terraform -chdir="$terraformDIR" apply -auto-approve \
    -var project_id="${PROJECT}" \
    -var project_number="${PROJECT_NUMBER}" \
    -var zone="${ZONE}" \
    -var basename="${BASENAME}" \
    -var region="${REGION}" \
    -var instance-disksize="${DISKSIZE}" \
    -var instance-disktype="${DISKTYPE}" \
    -var instance-image="${DISKIMAGE}" \
    -var instance-machine-type="${MACHINETYPE}" \
    -var instance-name="${NAME}" \
    -var instance-tags="${TAGS}" 


section_open "Test Instance"
    evalTest 'gcloud compute instances describe $NAME --zone="$ZONE" --format="value(name)"'  $NAME
section_close

section_open "Test Network"
    evalTest 'gcloud compute networks describe $BASENAME-network --format="value(name)"'  "$BASENAME-network"
section_close

section_open "Test Firewall Rule"
    evalTest 'gcloud compute firewall-rules describe deploystack-allow-ssh --format="value(name)"'  "deploystack-allow-ssh"
section_close


terraform -chdir="$terraformDIR" destroy -auto-approve \
    -var project_id="${PROJECT}" \
    -var project_number="${PROJECT_NUMBER}" \
    -var zone="${ZONE}" \
    -var basename="${BASENAME}" \
    -var region="${REGION}" \
    -var instance-disksize="${DISKSIZE}" \
    -var instance-disktype="${DISKTYPE}" \
    -var instance-image="${DISKIMAGE}" \
    -var instance-machine-type="${MACHINETYPE}" \
    -var instance-name="${NAME}" \
    -var instance-tags="${TAGS}" 

section_open "Test Firewall Rule does not exist"
    evalTest 'gcloud compute firewall-rules deploystack-allow-ssh --format="value(name)"'  "EXPECTERROR"
section_close

section_open "Test Network does not exist"
    evalTest 'gcloud compute networks describe $BASENAME-network --format="value(name)"' "EXPECTERROR"
section_close

section_open "Test Instance does not exist"
    evalTest 'gcloud compute instances describe $NAME --zone="$ZONE" --format="value(name)"'  "EXPECTERROR"
section_close

# This is only needed if you tests fail alot because of overlaping runs of the
# same set of tests. Really don't do this if you don't want to severly irritate 
# @tpryan
section_open "Delete Test Project"
    gcloud projects delete $PROJECT -q
section_close

printf "$DIVIDER"
printf "CONGRATS!!!!!!! \n"
printf "You got the end the of your test with everything working. \n"
printf "$DIVIDER"